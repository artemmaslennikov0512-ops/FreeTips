# Аудит проекта 1tips

**Дата:** 2026-02-27  
**Область:** безопасность, конфигурация, код, DevOps, документация.

---

## 1. Резюме

| Область | Оценка | Критические замечания |
|--------|--------|------------------------|
| Безопасность (Sec) | Хорошо | 0 |
| Тестирование (Test) | Приемлемо | 0 |
| Производительность (Perf) | Хорошо | 0 |
| Поддерживаемость (Maint) | Хорошо | 0 |
| DevOps/Platform | Хорошо | 0 |
| Документация (Doc) | Хорошо | 0 |
| Бизнес/Продукт (Biz) | Хорошо | 0 |

**Критических уязвимостей не выявлено.** Рекомендации — усиление практик и устранение низкоприоритетных замечаний.

---

## 2. Безопасность и соответствие (Sec)

### 2.1 Что сделано хорошо

- **Аутентификация:** bcrypt (12 раундов), JWT (access 15 мин, refresh 7 дней), отдельные секреты, `jose`, refresh в httpOnly cookie с ротацией.
- **Авторизация:** RBAC, `requireAuth`/`requireRole`, проверка `isBlocked`, ID из URL — первичные ключи Prisma (нет IDOR).
- **Ввод:** Zod на границах, лимиты длины, Prisma (параметризованные запросы) — нет SQL-инъекций.
- **CSRF:** проверка origin + double-submit (`x-csrf-token` vs cookie), исключения только для webhook и Bearer.
- **Заголовки:** CSP, HSTS, X-Frame-Options, nosniff, object-src 'none', Referrer-Policy, Permissions-Policy.
- **Секреты:** JWT/DATABASE/PAYMENT/SUPERADMIN только в `process.env`; `.env*` в `.gitignore`; в логах — санитизация (пароли, токены → `[REDACTED]`).
- **Webhook:** при Paygine — проверка подписи по Приложению №2 (XML + password); при stub — HMAC-SHA256 при заданном `PAYMENT_WEBHOOK_SECRET`; в production без секрета — отказ.
- **Rate limiting:** глобальный по API, отдельно auth, registration-requests, webhook, pay по IP/slug.
- **Body size:** `parseJsonWithLimit` / `readTextWithLimit` (512 KB auth, 256 KB webhook) — защита от DoS.
- **Path traversal:** пути к чекам из UUID из БД, не из пользовательского ввода.

### 2.2 Замечания

| Приоритет | Описание | Рекомендация |
|-----------|----------|--------------|
| **Средний** | В `prisma/seed.ts` пароль суперадмина выводится в консоль (`console.log(⚠️ Пароль: ${superAdminPassword})`). В CI или при перехвате логов возможна утечка. | Не логировать пароль; выводить только напоминание сменить его при первом входе. **Исправлено в рамках аудита.** |
| **Низкий** | В `.env` присутствуют реальные значения (JWT, PAYGINE_PASSWORD, SUPERADMIN). Файл в `.gitignore` — ок для разработки; для production убедиться, что используются только переменные окружения рантайма (Docker/CI secrets), не коммит. | Не коммитить `.env`; в production задавать секреты через секрет-менеджер/env деплоя. |
| **Низкий** | `PAYGINE_PASSWORD` в открытом виде в `.env`. Для тестового стенда допустимо; для боевого — только через защищённое хранилище. | В проде использовать секреты из vault/CI, не держать в репозитории. |
| **Инфо** | `scripts/.env` — правило `.env*` в `.gitignore` его покрывает; при добавлении исключений (например `!.env.example`) не включать `scripts/.env` в коммит. | Соблюдать текущий `.gitignore`. |

---

## 3. Тестирование и надёжность (Test)

- Есть тесты: `tests/security/csrf-client.test.ts`, `rate-limit.test.ts`, `validation/login.test.ts`, `payment.test.ts`.
- В CI: lint и build с тестовой БД; тесты можно добавить в pipeline (`npm run test`).
- Валидация конфигурации: JWT_SECRET/JWT_REFRESH_SECRET проверяются при первом использовании в `lib/auth/jwt.ts`.
- Рекомендация: добавить в CI шаг `npm run test` и при необходимости health check для контейнера (например, GET `/api/health`).

---

## 4. Производительность и масштабирование (Perf)

- Rate limit хранится in-memory (`Map`). При нескольких инстансах лимиты не общие.
- В коде есть комментарий: «В production использовать Redis».
- Рекомендация: для горизонтального масштабирования вынести rate limit в Redis (или аналог).
- Блокирующий I/O: Prisma/БД — приемлемо для текущей модели; при росте нагрузки рассмотреть пул и индексы (в schema индексы по основным полям запросов есть).
- Ограничение размера body защищает от перегрузки при больших запросах.

---

## 5. Поддерживаемость и чистота кода (Maint)

- Разделение: `lib/` (auth, payment, security, api helpers), `app/api/`, чёткие границы.
- Интерфейс платёжного шлюза (`PaymentGateway`), реализация Paygine и stub — понятная структура.
- Имена и комментарии на русском/английском по контексту, публичные API прослеживаются.
- Зависимости: актуальные версии Next 16, Prisma 6, jose, zod и др. Рекомендация: периодически обновлять с проверкой changelog на breaking changes.

---

## 6. Платформа и DevOps (DevOps)

- **Docker:** multi-stage build, непривилегированный пользователь `nextjs`, standalone output.
- **Миграции:** `prisma migrate deploy` в CMD — корректно для деплоя.
- **Конфигурация:** секреты через env (DATABASE_URL, JWT_*, PAYGINE_*, SUPERADMIN_*) — без хардкода в образе.
- **Graceful shutdown:** не проверялось детально; при использовании оркестраторов убедиться в корректном завершении соединений к БД и WebSocket.
- Рекомендация: при необходимости добавить в CMD или оркестратор проверку здоровья (например, раз в N секунд запрос к `/api/health`).

---

## 7. Документация (Doc)

- **SECURITY_AUDIT.md** и **SECURITY_CHECK.md** актуальны (по состоянию на 2026-02-09), отражают проверки и исправления.
- README, QUICK_START, STACK, docs/ (API, Paygine, ADR) присутствуют.
- Рекомендация: после изменений в auth/payment/security обновлять SECURITY_AUDIT.md и при необходимости ADR.

---

## 8. Бизнес и продукт (Biz)

- Функциональность соответствует описанию: чаевые, ссылки, транзакции, выплаты, интеграция Paygine, админка, суперадмин с обязательной сменой пароля.
- Переход с stub на Paygine по наличию `PAYGINE_SECTOR` и `PAYGINE_PASSWORD` — понятная конфигурация.
- Критических расхождений с типовыми требованиями к такому продукту не выявлено.

---

## 9. AQB Summary

```
[Sec] Секреты только в process.env; .env в .gitignore; логи санитизируются; webhook с проверкой подписи; CSRF, rate limit, body limit.
[Sec] Исправлено: seed не выводит пароль суперадмина в консоль.
[Test] Есть unit-тесты (csrf, rate-limit, validation); рекомендуется добавить npm run test в CI.
[Perf] Rate limit in-memory — для масштабирования рекомендован Redis.
[Maint] Структура и границы модулей понятные; зависимости актуальные.
[DevOps] Docker multi-stage, non-root, migrate deploy в CMD; конфиг через env.
[Doc] SECURITY_AUDIT.md, SECURITY_CHECK.md, README и docs актуальны.
[Biz] Соответствие заявленной функциональности; конфигурация переключения stub/Paygine ясна.
```

---

## 10. Чек-лист действий

- [x] Убрать вывод пароля суперадмина из `prisma/seed.ts` (выполнено).
- [x] В production без `NEXT_PUBLIC_APP_URL` не использовать origin для baseUrl (open redirect — исправлено в `lib/get-base-url.ts`).
- [x] Чеки: суперадмин может скачивать чеки любых выплат (`requireAuthOrApiKey` возвращает `role`, в receipt проверка `role === "SUPERADMIN"`).
- [x] Добавить в CI шаг `npm run test` (выполнено в `.github/workflows/ci.yml`).
- [x] Обновить SECURITY_AUDIT.md и SECURITY_CHECK.md (раздел 5 и дата).
- [ ] В production не хранить секреты в репозитории; использовать секрет-менеджер или env деплоя (организационная мера).
- [ ] При горизонтальном масштабировании внедрить Redis (или аналог) для rate limit (в коде добавлен комментарий-рекомендация).
- [ ] По желанию: health check для контейнера в оркестраторе (GET `/api/health`).
- [ ] При изменении механизмов безопасности обновлять SECURITY_AUDIT.md.
