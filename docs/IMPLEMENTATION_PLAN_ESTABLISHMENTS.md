# План внедрения: Заведения и официанты

**Проект:** 1tips  
**Основа:** [ANALYSIS_ESTABLISHMENT_EMPLOYEE_SPEC.md](./ANALYSIS_ESTABLISHMENT_EMPLOYEE_SPEC.md)

План разбит на фазы с конкретными задачами и путями к файлам в репозитории.

---

## Общая схема фаз

```
Фаза 1: Данные и роли     →  Фаза 2: Админ заведения  →  Фаза 3: Чаевые и распределение
        (Prisma, миграции)         (UI/API establishment)        (QR↔Employee, правила)

        →  Фаза 4: Официант и выплаты  →  Фаза 5: Доп. фичи и юридика
                   (кабинет, комиссии)           (White Label, ФНС, аудит)
```

---

## Фаза 1: Архитектура данных и роли

**Цель:** Ввести модели Establishment, Employee, PayoutRule; расширить User (роли, establishmentId). Текущий поток чаевых и выводов не ломать.

### 1.1 Prisma: новые модели и правки

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 1.1.1 | Добавить модель `Establishment` | `prisma/schema.prisma` | id, name, address, phone, logoUrl, uniqueSlug, createdAt; @@map("establishments") |
| 1.1.2 | Расширить enum `UserRole` | `prisma/schema.prisma` | Добавить ESTABLISHMENT_ADMIN, EMPLOYEE (RECIPIENT/ADMIN/SUPERADMIN оставить) |
| 1.1.3 | В User добавить establishmentId, связь | `prisma/schema.prisma` | establishmentId String? @db.VarChar, relation Establishment; опционально employeeProfile Employee? |
| 1.1.4 | Добавить модель `Employee` | `prisma/schema.prisma` | id, establishmentId, name, position, coefficient, isActive, qrCodeIdentifier, userId?; relation Establishment, User? |
| 1.1.5 | Добавить модель `PayoutRule` | `prisma/schema.prisma` | id, establishmentId, name, type (percentage/fixed), value (Decimal); relation Establishment |
| 1.1.6 | Создать миграцию | — | `npx prisma migrate dev --name add_establishments_employees_payout_rules` |

### 1.2 Обратная совместимость User

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 1.2.1 | Оставить поле `establishment` (текст) или пометить deprecated | `prisma/schema.prisma` | Решить: мигрировать данные в Establishment или оставить дублирование на переходный период |
| 1.2.2 | Маппинг ролей в коде | `app/admin/layout.tsx`, `lib/middleware/auth.ts`, др. | Там, где проверяется ADMIN — решить: считать ADMIN = ESTABLISHMENT_ADMIN или только SUPERADMIN для глобальной админки |

### 1.3 Проверки доступа по ролям

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 1.3.1 | Хелпер/функция проверки роли | `lib/auth/` или `lib/middleware/` | Например: `requireRole(["SUPERADMIN"])`, `requireEstablishmentAdmin()` (проверка establishmentId) |
| 1.3.2 | Суперадмин: доступ только к глобальной админке | `app/admin/layout.tsx` | Условие: только SUPERADMIN входит в `/admin` (текущее поведение сохранить) |
| 1.3.3 | Профиль: отображать establishmentId/заведение | `app/api/profile/route.ts`, `app/cabinet/settings/page.tsx` | Возвращать название заведения по establishmentId; в настройках при ESTABLISHMENT_ADMIN/EMPLOYEE показывать привязку к заведению (read-only или редакт — по продукту) |

**Результат Фазы 1:** В БД есть заведения, сотрудники и правила; пользователи могут иметь новые роли и привязку к заведению. Старый поток (RECIPIENT + TipLink + payouts) продолжает работать.

---

## Фаза 2: Админ-панель заведения

**Цель:** Отдельный раздел для админа заведения: управление командой (сотрудники, QR, PDF), настройка правил распределения. Без изменения логики начисления чаевых.

### 2.1 Роутинг и доступ

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 2.1.1 | Раздел приложения для админа заведения | `app/establishment/` | Создать layout: проверка role === ESTABLISHMENT_ADMIN и наличие establishmentId; редирект при отсутствии прав |
| 2.1.2 | Главная страница раздела | `app/establishment/page.tsx` | Дашборд: краткая сводка (кол-во сотрудников, последние действия), ссылки на команду и настройки распределения |

### 2.2 Управление командой (сотрудники)

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 2.2.1 | API: список сотрудников заведения | `app/api/establishment/employees/route.ts` | GET — список Employee по establishmentId текущего пользователя |
| 2.2.2 | API: создание сотрудника (ручной ввод) | `app/api/establishment/employees/route.ts` | POST — name, position?; генерация уникального qrCodeIdentifier (slug); создание TipLink для этого slug и привязка к User заведения или к "виртуальному" получателю (см. ниже) |
| 2.2.3 | API: деактивация сотрудника | `app/api/establishment/employees/[id]/route.ts` | PATCH — isActive: false; проверка establishmentId |
| 2.2.4 | Страница "Команда" | `app/establishment/team/page.tsx` | Список сотрудников, кнопки: добавить, деактивировать; отображение QR (ссылка или картинка) |
| 2.2.5 | Генерация PDF с QR-кодами | `lib/pdf/qr-cards.ts` или аналог | Функция: массив Employee → PDF (библиотека pdf-lib или react-pdf); API endpoint на скачивание PDF по списку id сотрудников |
| 2.2.6 | Приглашение по Email (опционально в Фазе 2) | `app/api/establishment/employees/[id]/invite/route.ts` | POST — отправка письма с ссылкой на регистрацию/привязку к сотруднику; интеграция с сервисом отправки (Resend, SendGrid и т.д.) |

### 2.3 Правила распределения (настройка)

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 2.3.1 | API: CRUD правил распределения | `app/api/establishment/payout-rules/route.ts`, `.../payout-rules/[id]/route.ts` | GET/POST/PATCH/DELETE с проверкой establishmentId |
| 2.3.2 | Страница "Распределение чаевых" | `app/establishment/payout-rules/page.tsx` | Список правил, создание/редактирование (name, type, value); подсказки по типам percentage/fixed |
| 2.3.3 | Коэффициенты у сотрудников | Уже в модели Employee (coefficient) | В форме редактирования сотрудника — поле коэффициент (для Варианта Б) |

### 2.4 Навигация

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 2.4.1 | Ссылка в хедере/меню для админа заведения | `components/Header.tsx`, при необходимости `app/cabinet/layout.tsx` | Если role === ESTABLISHMENT_ADMIN — показать пункт "Админ заведения" → `/establishment` |

**Результат Фазы 2:** Админ заведения может создавать сотрудников, скачивать PDF с QR, настраивать правила распределения и коэффициенты. Чаевые по-прежнему зачисляются на текущую модель (User + TipLink), если не меняем в Фазе 3.

---

## Фаза 3: Чаевые и распределение

**Цель:** Связать страницу оплаты по slug с сотрудником заведения; ввести логику "общих" чаевых и распределение по правилам.

### 3.1 Связь оплаты по slug с Employee

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 3.1.1 | Разрешить slug = qrCodeIdentifier сотрудника | `app/api/pay/[slug]/route.ts` | При запросе: сначала TipLink по slug; если нет — искать Employee по qrCodeIdentifier; при оплате записывать получателя (userId из Employee или "пул заведения") |
| 3.1.2 | Модель транзакции: привязка к сотруднику/заведению | `prisma/schema.prisma` (опционально) | Поле employeeId или establishmentId в Transaction — для отчётов и распределения; при наличии — считать чаевые "личные" (100% сотруднику) или "в пул" |
| 3.1.3 | Создание TipLink при создании Employee | Логика в API создания сотрудника | Чтобы оплата по qrCodeIdentifier работала через текущий поток: при создании Employee создавать TipLink (userId = чей? — "служебный" User заведения или отдельная сущность "получатель заведения"); уточнить продуктово |

### 3.2 Пул "общих" чаевых и распределение

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 3.2.1 | Сущность "общие чаевые" (ручной ввод админом) | `prisma/schema.prisma` | Модель например ManualTipPool: id, establishmentId, amountKop, period (date/shift), createdAt; или один общий "счёт" заведения с движениями |
| 3.2.2 | API: внесение суммы в пул | `app/api/establishment/tip-pool/route.ts` | POST — amountKop, дата/смена; проверка прав establishment_admin |
| 3.2.3 | Сервис распределения | `lib/distribution/` или `lib/establishment/` | Функция: заведение + период + правила + список активных сотрудников (и коэффициенты) → массив { employeeId, amountKop }; Вариант А: равномерно; Вариант Б: по коэффициентам |
| 3.2.4 | Зачисление распределённых сумм | Решение по продукту | Либо создание "внутренних" транзакций/начислений на баланс User, привязанных к Employee; либо отдельная таблица Allocation с последующим учётом в балансе при выводе |
| 3.2.5 | Аудит: лог изменений распределений | `prisma/schema.prisma` + API | Таблица DistributionAuditLog: кто, когда, что изменил (только append); запрет редактирования распределений за прошедшие периоды в коде |

### 3.3 Отчёты и аналитика

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 3.3.1 | API: статистика по заведению | `app/api/establishment/stats/route.ts` | По establishmentId: сумма чаевых за период, по сотрудникам, по дням |
| 3.3.2 | Страница "Аналитика" | `app/establishment/analytics/page.tsx` | Графики (например recharts): топ дней, топ сотрудников; экспорт CSV/PDF для бухгалтерии |

**Результат Фазы 3:** Оплата по QR сотрудника зачисляется корректно; админ может вносить "общие" чаевые и запускать распределение по правилам; история распределений не редактируется задним числом.

---

## Фаза 4: Официант (Employee Mode) и выплаты

**Цель:** Удобный кабинет для официанта (начисления, рейтинг), вывод на карту; опция пониженной комиссии для заведений.

### 4.1 Личный кабинет официанта

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 4.1.1 | Определение контекста "официант" | `app/cabinet/layout.tsx` или хук | Если user.role === EMPLOYEE и есть employeeProfile — показывать блок "Мои начисления" / "Рейтинг" |
| 4.1.2 | API: начисления официанта | `app/api/cabinet/allocations/route.ts` или расширить transactions | Список начислений (из распределения) за период для текущего User (через Employee) |
| 4.1.3 | Страница/блок "История начислений" | `app/cabinet/page.tsx` или `app/cabinet/allocations/page.tsx` | Таблица: дата, источник (личный QR / общий пул), сумма |
| 4.1.4 | Рейтинг (опционально) | Отдельная сущность или производная от отзывов | Если в продукте есть "рейтинг" — модель Review/Feedback при оплате; расчёт рейтинга по сотруднику |

### 4.2 Вывод и комиссии

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 4.2.1 | Пониженная комиссия для сотрудников заведения | `lib/payout-limits.ts` или конфиг | Флаг/процент в Establishment или в конфиге: при payout для User с establishmentId — другой лимит/комиссия (если продукт предусматривает) |
| 4.2.2 | Мгновенные выплаты | Отдельный контур | Новый тип заявки или интеграция с провайдером мгновенных переводов; комиссия и лимиты — отдельная задача и юридика |

**Результат Фазы 4:** Официант видит свои начисления и может выводить средства; при необходимости для заведений применяется отдельная комиссия.

---

## Фаза 5: Дополнительно (фишки, юридика, антифрод)

**Цель:** White Label, благотворительность/геймификация по желанию; юридическая схема и ФНС; закрепление антифрода.

### 5.1 White Label

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 5.1.1 | Отдача конфига заведения на страницу оплаты | `app/api/pay/[slug]/route.ts` (GET) или отдельный endpoint | По slug заведения (или по slug сотрудника → заведение) вернуть logoUrl, цвета (если храним); фронт страницы оплаты подставляет лого и тему |
| 5.1.2 | Поля темы в Establishment | `prisma/schema.prisma` | Опционально: primaryColor, secondaryColor (Varchar) |

### 5.2 Юриспруденция и безопасность

| # | Задача | Файл | Действие |
|---|--------|------|----------|
| 5.2.1 | ADR: юридическая схема (агент, комиссия, выплата официанту) | `docs/adr/0003-legal-payout-flow.md` | Описание: кто контрагент, поток денег, самозанятость |
| 5.2.2 | Проверка ФНС (самозанятость) перед выплатой | `lib/tax/` или внешний сервис | Адаптер к API ФНС; вызов перед одобрением выплаты; при отсутствии статуса — блок или удержание НДФЛ (с юристом) |
| 5.2.3 | Аудит-лог изменений правил и распределений | Реализовано в Фазе 3; при необходимости расширить | Все изменения PayoutRule и ручные корректировки пула — в audit-таблицу; в коде запрет изменения задним числом |

### 5.3 Опционально: благотворительность, геймификация, iiko

| # | Задача | Зависимости |
|---|--------|-------------|
| 5.3.1 | Благотворительность: правило "X% в фонд" | PayoutRule с типом "charity" или отдельная сущность; выбор фонда в настройках заведения |
| 5.3.2 | Геймификация: отзыв при оплате, звания | Модель Review; расчёт рейтинга по Employee; бейджи по правилам |
| 5.3.3 | Интеграция iiko/R-Keeper | Отдельный bounded context, API САУ, маппинг стол→официант; дорого по времени |

---

## Порядок выполнения (чек-лист)

- [ ] **Фаза 1:** Prisma + миграции + роли + проверки доступа  
- [ ] **Фаза 2:** Раздел `/establishment`, команда (CRUD сотрудников, QR, PDF), настройка правил распределения  
- [ ] **Фаза 3:** Связь slug ↔ Employee, пул общих чаевых, сервис распределения, аудит, отчёты  
- [ ] **Фаза 4:** Кабинет официанта (начисления), комиссии для заведений  
- [ ] **Фаза 5:** White Label, ADR и ФНС, при необходимости — благотворительность, геймификация, САУ  

Зависимости между фазами: 2 и 3 можно частично распараллелить (например, сначала только CRUD сотрудников и QR без распределения), но полноценное распределение (Фаза 3) опирается на Фазу 1 и 2.
