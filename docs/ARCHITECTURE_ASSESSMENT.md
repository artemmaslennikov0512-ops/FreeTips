# Оценка архитектуры: соответствие стандартам enterprise fintech

**Вопрос:** Соответствует ли архитектура стандартам enterprise fintech, соблюдаются ли SOLID, Hexagonal, DDD, разбивка по слоям, принцип единственной ответственности (домены не лезут в репозитории и т.д.), везде ли есть выделение по слоям?

**Краткий ответ:** **Нет.** Текущая архитектура — типичный «тонкий слой над БД» (Next.js API routes + Prisma). Для enterprise fintech ожидаются явные слои (domain, application, infrastructure), порты и адаптеры (Hexagonal), ограниченные контексты (DDD) и соблюдение SOLID; этого в проекте **нет**. Есть только **частичная** изоляция по одному направлению (платежи через интерфейс `PaymentGateway`).

---

## 1. Текущее состояние

### 1.1 Структура каталогов

```
app/api/          — HTTP-обработчики (доставка)
lib/              — смесь: БД, auth, payment, validations, security, middleware
prisma/           — схема и миграции (инфраструктура данных)
config/           — конфиг сайта
components/       — UI
```

Отдельных каталогов **domain**, **application**, **infrastructure** нет. Нет явного разделения на слои.

### 1.2 Зависимости от БД

- **API routes** напрямую импортируют `db` из `@/lib/db` и вызывают `db.user.findUnique`, `db.transaction.create`, `db.payoutRequest.*` и т.д.
- **lib/middleware/auth.ts** (проверка JWT и прав) напрямую вызывает `db.user.findUnique`.
- **lib/balance.ts** считает баланс через прямые вызовы `db.transaction.aggregate` и `db.payoutRequest.aggregate`.
- **lib/payment/stub-gateway.ts** (адаптер платежей) сам вызывает `db.transaction.findUnique/create`.

То есть слой доставки (HTTP) и «логика приложения» напрямую зависят от конкретной реализации персистенции (Prisma). Репозиториев и абстракций доступа к данным нет.

### 1.3 Единственное Hexagonal-подобное место: платежи

- **Порт:** `lib/payment/gateway.ts` — интерфейс `PaymentGateway` (createPayment, getStatus, handleWebhook).
- **Адаптер:** `lib/payment/stub-gateway.ts` — реализация, внутри использует `db`.

Use case (инициализация платежа) в `app/api/pay/[slug]/route.ts` зависит от шлюза через `getPaymentGateway()`, т.е. от абстракции, а не от Prisma. Остальная логика (пользователи, сессии, выводы, заявки, статистика) к портам/адаптерам **не приведена** — везде прямой доступ к `db`.

### 1.4 DDD

- **Агрегатов, сущностей домена, value objects** нет. Роль «моделей» выполняют только типы Prisma (схема БД).
- **Доменных сервисов** нет. Правила вида «пользователь заблокирован», «пароль верный», «баланс = поступления − выводы» размазаны по route handlers, `lib/auth`, `lib/balance`.
- **Bounded contexts** не выделены (нет явных границ «Identity», «Payments», «Payouts», «Reporting» и т.д.).
- **Репозитории** отсутствуют: домен не может «не лезть в репозитории», потому что слоя домена и слоя репозиториев просто нет — в репозитории «лезут» сами HTTP‑обработчики и сервисы из `lib/`.

### 1.5 SOLID

| Принцип | Соблюдение | Комментарий |
|--------|------------|-------------|
| **S** (Single Responsibility) | Частично нарушен | Route handlers делают: парсинг тела, валидацию, вызов БД, бизнес-проверки, формирование ответа. Один handler — несколько причин для изменений. |
| **O** (Open/Closed) | Только по платежам | Подключить другой платёжный провайдер можно без правок use case (через новый адаптер). Для пользователей, выводов, заявок — расширение только прямым изменением кода. |
| **L** (Liskov) | — | Мало иерархий/подстановок, явных нарушений нет. |
| **I** (Interface Segregation) | Приемлемо | Интерфейсы небольшие (например, `PaymentGateway`). |
| **D** (Dependency Inversion) | Нарушен | Маршруты и сервисы зависят от конкретики: `db`, `getPaymentGateway()`. Нет инъекции абстракций репозиториев/шлюзов в «ядро» приложения. Домен (если бы был) должен бы зависеть от интерфейсов репозиториев — такого слоя нет. |

### 1.6 Разделение по слоям

- **Слой доставки (delivery):** `app/api/**` — HTTP. Но он же содержит оркестрацию и вызовы БД, т.е. смешан с «приложением» и персистенцией.
- **Слой приложения (application / use cases):** не выделен. Сценарии «логин», «создать платёж», «получить баланс», «одобрить заявку» реализованы внутри route handlers или в `lib/` (balance, auth).
- **Доменный слой (domain):** отсутствует. Нет папки `domain/`, нет сущностей/агрегатов, инвариантов и правил в одном месте.
- **Инфраструктура (infrastructure):** частично есть (Prisma, JWT, платёжный stub), но не отграничена портами: маршруты и логика напрямую используют `db` и конкретные модули.

Итого: **явной разбивки по слоям нет**; границы «домен не знает о репозиториях», «use case не знает о Prisma» не соблюдаются, потому что слоёв домена и use case в явном виде нет, а слой доставки и «логика» напрямую работают с репозиториями (фактически с Prisma).

---

## 2. Соответствие стандартам enterprise fintech

В типичных стандартах enterprise fintech ожидается:

- Чёткое разделение на **domain**, **application**, **infrastructure**, **delivery**.
- **Hexagonal:** входящие/исходящие зависимости идут через порты (интерфейсы); адаптеры (в т.ч. репозитории, шлюзы) реализуют порты снаружи «ядра».
- **DDD:** доменная модель (агрегаты, сущности, value objects), репозитории как интерфейсы в домене/приложении, при необходимости — bounded contexts.
- **SOLID:** в т.ч. DIP — домен и use cases не зависят от конкретной БД или фреймворка; зависимости направлены внутрь (к домену).

В текущем проекте:

- Нет выделенного доменного слоя и репозиториев.
- Нет слоя приложения (use cases) с инжектируемыми портами.
- Есть только один «островок» Hexagonal (платежи через `PaymentGateway`).
- Домен не «не лезет в репозитории» — домена нет, в БД «лезут» маршруты и сервисы из `lib/`.

Поэтому архитектура **не соответствует** заявленным стандартам enterprise fintech и принципам «слои + Hexagon + DDD + единственная ответственность и изоляция домена».

---

## 3. Что есть хорошего

- Валидация на границе (Zod) вынесена в `lib/validations.ts` — единое место для контрактов ввода.
- Платежи изолированы за интерфейсом `PaymentGateway` — можно подменить реализацию.
- Auth (JWT, пароли, сессии) вынесен в `lib/auth/` и используется из маршрутов — хотя бы не размазан по всем handler’ам.
- Нет «богов» в одном файле: логика по эндпоинтам разбита по файлам.

Это не заменяет слои и DDD, но даёт базу для последующего рефакторинга.

---

## 4. Целевая картина (кратко) для соответствия стандартам

Чтобы приблизиться к enterprise fintech, SOLID, Hexagonal и DDD:

1. **Domain (ядро)**  
   - Папка `domain/` (или по bounded context: `domain/identity`, `domain/payments`, `domain/payouts`).  
   - Сущности/агрегаты и value objects (без импортов Prisma/БД).  
   - Интерфейсы репозиториев в домене/приложении, например: `UserRepository`, `PayoutRequestRepository`, `TransactionRepository`.  
   - Доменные правила (блокировка, лимиты и т.д.) в домене, а не в route.

2. **Application (use cases)**  
   - Папка `application/` или `use-cases/`: сценарии «LoginUser», «CreatePayment», «GetBalance», «ApproveRegistrationRequest» и т.д.  
   - Use case принимает репозитории и шлюзы через конструктор (DIP).  
   - Внутри — оркестрация: вызов репозиториев, доменных сервисов, внешних портов (PaymentGateway); без вызова Prisma или Next.

3. **Infrastructure**  
   - Реализации репозиториев (например, `PrismaUserRepository`), реализация `PaymentGateway` (уже есть stub).  
   - Всё, что связано с БД, внешними API, файлами — только в инфраструктуре.

4. **Delivery**  
   - В `app/api/**` только: парсинг HTTP, вызов одного use case, маппинг результата в ответ. Без прямых вызовов `db` и без доменной логики.

5. **Зависимости**  
   - Направление зависимостей: delivery → application → domain; infrastructure → реализует порты, объявленные в domain/application.  
   - Домен не импортирует репозитории «как классы БД» — он зависит только от интерфейсов (портов). Репозитории «не лезут» в домен; домен задаёт контракт, инфраструктура его реализует.

---

## 5. Итог

| Критерий | Соответствие |
|----------|----------------|
| Enterprise fintech (слои, изоляция, DDD, Hexagonal) | **Нет** |
| SOLID | **Частично** (DIP и SRP нарушены; по платежам — OCP соблюдён) |
| Hexagonal (порты/адаптеры) | **Только платежи**; остальное — прямой доступ к БД |
| DDD (агрегаты, репозитории, bounded contexts) | **Нет** |
| Разбивка по слоям (domain / application / infrastructure / delivery) | **Нет** |
| Домены не лезут в репозитории | **Нерелевантно** — доменного слоя нет; в «репозитории» (Prisma) лезут маршруты и сервисы |

Текущая кодовая база удобна для MVP и небольшой команды, но **не соответствует** заявленным стандартам enterprise fintech по слоям, SOLID, Hexagonal и DDD. Чтобы им соответствовать, нужна явная введение слоёв, портов репозиториев и платежей, и вынос сценариев в use cases с зависимостями «внутрь» (DIP).
