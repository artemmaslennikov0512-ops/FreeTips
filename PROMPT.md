# Промпт проекта: Платформа безналичных чаевых (аналог 1tips.ru)

## 1. Цель и контекст

Разработать **веб-платформу для приёма безналичных чаевых**, функционально аналогичную 1tips.ru, с **новым, отличным от оригинала, но столь же современным и привлекательным дизайном**. Продукт рассчитан на официантов, курьеров, мастеров, барберов и другие категории получателей чаевых.

---

## 2. Требования к качеству кода и безопасности

### 2.1 Стандарты кода (FinTech-уровень)

- **Язык и стиль:** TypeScript строгий режим; ESLint + Prettier; соглашения: Airbnb или stricter. Без `any`, без необработанных исключений.
- **Архитектура:** Чистая, модульная: разделение на домены (auth, tips, payouts, links, users). Слои: API → Use Cases/Services → Repositories. Зависимости — через DI или фабрики, не через глобальные синглтоны.
- **Безопасность:**
  - Все пользовательские данные: валидация на входе (Zod/io-ts/Yup), санитизация, лимиты размера/частоты.
  - Аутентификация: JWT с коротким access и refresh в httpOnly cookie; обновление по refresh; инвалидация при смене пароля/логине с нового устройства.
  - Авторизация: RBAC (роли: официант, админ и т.п.); проверка прав на каждый эндпоинт и на уровне UI (скрытие/блокировка).
  - Секреты и ключи: только в env (не в коде); различие dev/stage/prod; ротация ключей — документирована.
  - Логирование: без паролей, токенов, карт; маскирование персональных данных; структурированные логи (JSON) с requestId.
  - Защита: rate limiting (по IP и по userId), CORS, CSP, HSTS; подготовка к WAF при необходимости.
- **Работа с деньгами:**
  - Все суммы — в минимальных единицах (копейки) в БД и внутри логики; округление — явное и по правилам (банковское).
  - Идемпотентность платёжных операций (idempotency key); корректная обработка дублей и таймаутов; согласованность через транзакции.
- **Тестируемость:** Юнит-тесты для бизнес-логики; интеграционные — для API и репозиториев; моки для внешнего платёжного API.

---

## 3. Функциональные блоки

### 3.1 Публичный лендинг (маркетинговый сайт)

- **Секции (референс 1tips.ru, с новым дизайном):**
  - Главный экран: ценность «чаевые картой мгновенно», CTA «Подключиться».
  - О сервисе, Как это работает (3 шага: QR/ссылка → сумма и отзыв → оплата), Адаптация (моментальное подключение, дизайн, распределение чаевых, аналитика), Для кого (официанты, курьеры, мастера и т.д.), FAQ, Контакты.
- **Навигация:** хедер с логотипом, якорные ссылки, кнопка «Личный кабинет» / «Войти».
- **Футер (лендинг):** логотип, ссылки на документы (оферта, политика конфиденциальности/обработки ПД, контакты), реквизиты оператора (название, адрес, ИНН, ОГРН — по желанию), поддержка (телефон, email, Telegram — по желанию). Дизайн — в стиле сайта. Данные футера выносятся в конфиг; **значения для подстановки ты пришлёшь позже** — см. `FOOTER_DATA.placeholder.md`.
- **Страницы документов:** /oferta (оферта / пользовательское соглашение), /politika (политика конфиденциальности или обработки ПД), /kontakty (контакты). Контент — статический или из MD/CMS; тексты ты пришлёшь позже.
- **Футер на страницах документов** (/oferta, /politika, /kontakty): такой же блок, как на лендинге (ссылки на документы, контакты, реквизиты, логотип), по аналогии с 1tips.ru.
- **Адаптивность:** mobile-first; корректная работа на телефонах, планшетах, десктопах.
- **Без JS:** базовая навигация и контент доступны; формы — с прогрессивным улучшением.

### 3.2 Авторизация и регистрация

- **Регистрация:** телефон (или email — явно указать в требованиях); подтверждение через SMS/код (или email-link). Пароль: политика сложности, запрет типовых паролей.
- **Вход:** логин (телефон/email) + пароль; опция «Запомнить» — только через продлённый refresh.
- **Восстановление пароля:** запрос по телефону/email, одноразовая ссылка или код с ограниченным TTL.
- **Сессии:** отображение активных сессий и возможность «Выйти везде» — желательно в MVP или в ближайшей итерации.

### 3.3 Личный кабинет (ЛК) официанта / получателя чаевых

- **Профиль:** просмотр и редактирование (телефон, имя, при необходимости — реквизиты для выплат). Смена пароля.
- **История платежей (чаевых):**
  - Таблица: дата/время, сумма, источник (по ссылке/QR, идентификатор), статус (успешно/в обработке/ошибка). Фильтры: период, статус. Экспорт (CSV) — в MVP или чуть позже.
- **Вывод средств:**
  - Запрос вывода на привязанную карту/счёт. Форма: сумма, реквизиты (если не сохранены), подтверждение (пароль/2FA по желанию). Статусы: «Создан», «В обработке», «Выполнен», «Отклонён». Лимиты и комиссии — по документации платежки.
- **Уникальные ссылки и QR:**
  - Генерация персонализированной ссылки (например, `/{base}/t/{uniqueId}` или `/{base}/pay/{slug}`). Ссылка — постоянная для пользователя (или с возможностью несколько «витрин» — опционально в MVP).
  - Для каждой ссылки — **QR-код** (SVG или PNG, размер настраиваемый). Скачивание/печать.
  - В ЛК: список своих ссылок (если их несколько), копирование ссылки, превью/скачивание QR.

### 3.4 Страница приёма чаевых (по уникальной ссылке)

- **Контент:** отображается имя получателя (или название «витрины»), опционально — фото/аватар, приветственный текст.
- **Выбор суммы:** фиксированные кнопки (например, 50, 100, 200, 500, «Своя») и поле «Своя сумма»; валидация мин/макс (по настройкам или глобально).
- **Отзыв (опционально):** текстовое поле, лимит символов; не обязательно для оплаты.
- **Оплата:** интеграция с платёжным провайдером (API — по твоей документации). Поддержка: карты, Apple Pay, Google Pay, Samsung Pay — по возможностям API.
- **QR на странице:** на странице перехода по ссылке должен отображаться тот же QR (или дублирующий), чтобы можно было «показать экран» и дать отсканировать другому гостю.
- **Успех/ошибка:** ясные экраны после оплаты; при успехе — благодарность; при ошибке — сообщение и возможность повторить.
- **Без регистрации для плательщика:** гость не должен создавать аккаунт; только ввод карты и подтверждение.

---

## 4. Платёжная интеграция

- Документацию по API платежки ты предоставишь позже.
- Требования к интеграции (заложить в архитектуру):
  - Выделенный **модуль/адаптер** (PaymentGateway) с интерфейсом: создание платежа, проверка статуса, вебхуки для уведомлений. Реализация — под конкретный API.
  - Все вызовы к провайдеру — через сервис, без прямой работы с HTTP в контроллерах. Retry с экспоненциальной задержкой; таймауты; логирование запросов/ответов без чувствительных полей.
  - Обработка вебхуков: проверка подписи; идемпотентность; асинхронное обновление статусов и зачисление на баланс/историю.
  - Тестовый (sandbox) и боевой режимы; переключение через конфиг.

---

## 5. MVP (первая версия для быстрого запуска)

### В scope MVP

1. **Лендинг** — все основные секции, новый дизайн, адаптив, **футер** (ссылки на документы, контакты, реквизиты — данные из конфига/плейсхолдера), форма «Подключиться» (ведёт на регистрацию или оставление контактов).
2. **Auth:** регистрация (телефон + SMS-код), вход, восстановление пароля. Роль: один тип пользователя — «получатель чаевых» (официант).
3. **ЛК получателя:**
   - Профиль (имя, телефон, смена пароля).
   - Одна уникальная ссылка на пользователя + генерация и отображение QR.
   - История платежей (список с датой, суммой, статусом).
   - Запрос вывода: форма (сумма, реквизиты), список заявок со статусами. Логика списания с баланса — по факту прихода вебхука «успех» от платежки.
4. **Страница по ссылке:**
   - Выбор суммы (фиксированные + своя), опционально отзыв, кнопка «Оплатить» → редирект/виджет платежки. На странице — QR-код этой же ссылки.
   - Экраны успеха/ошибки.
5. **Платёжный модуль:** заглушка/адаптер с интерфейсом; реализация — после получения документации API. До этого — симуляция успешного платежа для демо.
6. **Страницы документов и футер:** /oferta, /politika, /kontakty — статический каркас (тексты подставишь позже); на каждой **футер как на 1tips** (логотип, ссылки на документы, контакты, реквизиты). Данные футера — из `FOOTER_DATA.placeholder.md` / конфига, значения пришлёшь позже.

### Вне scope MVP (после запуска)

- Несколько «витрин»/ссылок на одного пользователя.
- Админ-панель (модерация пользователей, просмотр транзакций, настройка комиссий).
- Расширенная аналитика, дашборды, экспорт отчётов.
- Кастомизация страницы оплаты (цвета, лого) под бренд.
- Интеграция с 1С/кассами, чеки.
- Поддержка чаевых «с чека» (привязка к счёту в ресторане).

---

## 6. Дизайн и UX

- **Отличие от 1tips.ru:** визуальный стиль, типографика, цветовая палитра, форма и расположение блоков — свои. Референс по функциям и структуре — 1tips, по «лицу» — нет.
- **Качество:** современный, аккуратный UI; достаточный контраст и размер шрифтов (a11y); предсказуемая навигация; быстрая загрузка; скелетоны/лоадеры при ожидании.
- **Библиотеки:** на твоё усмотрение (React/Vue/Svelte + Tailwind или аналог); иконки — единый набор (например, Lucide, Heroicons). Компоненты — переиспользуемые, с вариантами (размер, тип).

---

## 7. Технологический стек (рекомендация, можно скорректировать)

- **Frontend:** React 18+ (или Next.js для SSR/SEO лендинга) + TypeScript, Tailwind CSS, React Query (или SWR), Zustand или React Context для глобального состояния (auth).
- **Backend:** Node.js (Express/Fastify) или Next.js API Routes; TypeScript. ORM: Prisma или Drizzle. БД: PostgreSQL.
- **Инфраструктура (позже):** Docker, CI/CD, размещение (Vercel/Railway/AWS — по предпочтениям). Для MVP — запуск через Docker и одна среда (staging).
- **QR:** библиотека `qrcode` или `qr-code-styling` (в том числе для кастомизации под дизайн).

---

## 8. Структура проекта и репозиторий

- Монорепо или раздельные `frontend` / `backend` — по удобству. Важно: общие типы (ts-shared или packages/types) для контрактов API и доменных сущностей.
- `.env.example` с перечнем переменных (без значений); README с инструкцией по запуску, миграциям и тестам.
- Документация API: OpenAPI (Swagger) или аналог; при необходимости — Postman-коллекция для платежной интеграции.

---

## 9. Документация и артефакты

- **TODO.md (или TASKS.md):** единый файл задач; обновляется по мере выполнения. Формат: статус (Todo / In Progress / Done), приоритет, краткое описание, ссылка на модуль/файл при необходимости.
- **ARCHITECTURE.md (позже):** схема модулей, потоков данных, интеграций.
- **PAYMENT_API.md:** твои заметки по API платежки после получения документации — эндпоинты, коды, вебхуки, тестовые ключи.

---

## 10. Пошаговый план (для синхронизации с TODO)

1. Инициализация: репозиторий, структура папок, линтеры, базовый конфиг (TS, ESLint, Prettier, env).
2. Схема БД: пользователи, сессии, ссылки, транзакции (чаевые), выводы, идемпотентность платежей. Миграции.
3. Бэкенд: auth (регистрация, вход, refresh, восстановление), middleware (auth, RBAC, rate limit, валидация).
4. API: профиль, ссылки и QR, история платежей, заявки на вывод. Заглушка PaymentGateway.
5. Лендинг: вёрстка всех секций, навигация, **футер** (данные из FOOTER_DATA), форма «Подключиться». Страницы документов /oferta, /politika, /kontakty и футер на них.
6. ЛК: каркас (роутинг, layout), профиль, ссылка+QR, история, вывод.
7. Страница чаевых: форма суммы/отзыва, QR на странице, интеграция с заглушкой платежа; экраны успеха/ошибки.
8. Интеграция с реальным API платежки (после документации): реализация адаптера, вебхуки, тесты.
9. Тесты: юнит (сервисы, утилиты), интеграционные (API, платёжный модуль).
10. Деплой: Docker, CI, staging; чек-лист перед prod (безопасность, лимиты, мониторинг).

---

## 11. Уточняющие вопросы (на которые нужно ответить до или в ходе разработки)

1. **Регистрация:** только телефон или ещё email? Какой SMS-шлюз планируется (Twilio, local, другой)?
2. **Платежи:** только РФ (рубли, российские карты) или мультивалютность? Нужны ли чеки (54-ФЗ)?
3. **Вывод:** на карту РФ, на счёт, несколько реквизитов? Минимальная сумма, комиссия — считаем на нашей стороне или полностью по API?
4. **Домен и бренд:** имя сервиса, домен (для ссылок вида `https://domain/t/xxx`)? Нужен ли отдельный поддомен для платёжной страницы?
5. **Юрлицо и комплаенс:** кто оператор; нужна ли отдельная политика конфиденциальности, оферта, согласие на обработку ПД до MVP?
6. **Данные футера:** реквизиты оператора (название, адрес, ИНН, ОГРН), контакты поддержки (телефон, email, Telegram), точные URL или пути к оферте и политике — ты пришлёшь для подстановки в `FOOTER_DATA.placeholder.md` / конфиг.

---

*Этот промпт — живой документ: по мере появления документации по API платежки и ответов на вопросы разделы 4, 5 и 11 должны обновляться. TODO.md ведётся параллельно и отражает текущее состояние задач.*
