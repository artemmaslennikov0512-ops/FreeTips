# Отчёт по уязвимостям: OWASP Top 10 и прочие

**Дата:** 2026-02-27  
**Методология:** OWASP Top 10 (2021) + дополнительные векторы.

---

## OWASP Top 10 (2021) — проверка по категориям

### A01:2021 — Broken Access Control

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | **Open Redirect (редирект после оплаты).** В `POST /api/pay/[slug]` для формирования `redirectUrl` использовался `getBaseUrlFromRequest(request.nextUrl.origin)`. При ненастроенном `NEXT_PUBLIC_APP_URL` в production теперь `getBaseUrlFromRequest` возвращает пустую строку — создание платежа завершится ошибкой «Не указан baseUrl для редиректа». В production необходимо задавать `NEXT_PUBLIC_APP_URL`. | **Средний** | **Исправлено** |
| 2 | Доступ к API админки и данным пользователей ограничен через `requireRole(["ADMIN","SUPERADMIN"])`; ID в URL — первичные ключи Prisma, проверка прав по JWT. IDOR не выявлен. | — | ОК |
| 3 | Чеки выплат (`/api/payouts/[id]/receipt`): доступ владельцу заявки или SUPERADMIN. Реализовано через возврат `role` в `requireAuthOrApiKey` и проверку `role === "SUPERADMIN"`. | — | **Исправлено** |

**Исправление A01.1:** В `getBaseUrlFromRequest` в production при отсутствии `NEXT_PUBLIC_APP_URL` возвращается пустая строка (origin не используется). Для работы оплаты в production необходимо задавать `NEXT_PUBLIC_APP_URL`.

---

### A02:2021 — Cryptographic Failures

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | Пароли: bcrypt, 12 раундов. Хранение только хеша. | — | ОК |
| 2 | JWT: HS256, отдельные секреты для access/refresh, секреты только в `process.env`. | — | ОК |
| 3 | Передача только по HTTPS в production (cookie `secure`, HSTS). | — | ОК |
| 4 | Секреты (JWT, PAYGINE_*, SUPERADMIN) не в коде; `.env` в `.gitignore`. В production секреты должны задаваться через env деплоя/секрет-менеджер. | — | ОК |

Критических нарушений не выявлено.

---

### A03:2021 — Injection

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | **SQL:** Все запросы через Prisma (параметризованные). Единственный raw — `db.$queryRaw(Prisma.sql\`SELECT 1\`)` в health (без пользовательского ввода). | — | ОК |
| 2 | **NoSQL/команды:** Не используется. | — | ОК |
| 3 | **XSS:** В приложении один вызов `dangerouslySetInnerHTML` в `app/layout.tsx` — статичная строка скрипта (тема, pathname), без пользовательского ввода. Остальной вывод через React (экранирование по умолчанию). В `redirect-proxy` значения формы экранируются через `escapeHtml`. | Низкий | ОК (контролируемый контент) |
| 4 | **Command/OS:** Пользовательский ввод не подставляется в команды или пути файлов. Пути к чекам и шрифтам строятся из `payout.id` (БД) или констант. | — | ОК |

---

### A04:2021 — Insecure Design

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | Регистрация только по токену; лимиты на выплаты; обязательная смена пароля суперадмина. | — | ОК |
| 2 | Зависимость baseUrl от request origin при ненастроенном `NEXT_PUBLIC_APP_URL` — см. A01 (open redirect). | Средний | См. A01 |

---

### A05:2021 — Security Misconfiguration

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | Заголовки безопасности: CSP, HSTS, X-Frame-Options, nosniff, Referrer-Policy, Permissions-Policy, object-src 'none'. | — | ОК |
| 2 | CSP: `unsafe-inline` для script/style (требования Next.js), в production без `unsafe-eval`. | Низкий | Принято |
| 3 | Health (`/api/health`) отдаёт только `status`, `db`, `paygineConfigured`, `latencyMs`, `timestamp` — без секретов. | — | ОК |
| 4 | Режим отладки/ошибки: в production детали ошибок (например, в receipt) не отдаются клиенту. | — | ОК |

---

### A06:2021 — Vulnerable and Outdated Components

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | Зависимости: Next 16, Prisma 6, jose, bcryptjs, zod — актуальные. Рекомендуется периодический аудит (`npm audit`) и обновления. | Низкий | Рекомендация |

---

### A07:2021 — Identification and Authentication Failures

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | Логин: единое сообщение «Неверный логин или пароль» — нет перечисления пользователей. | — | ОК |
| 2 | Rate limit на auth (20 запросов / 15 мин по IP). | — | ОК |
| 3 | Refresh token в httpOnly cookie, ротация при refresh, проверка в БД, истёкшие/заблокированные обрабатываются. | — | ОК |
| 4 | Смена пароля: проверка текущего пароля, инвалидация сессий. | — | ОК |
| 5 | API ключ (X-API-Key): проверка в БД, привязан к пользователю. Длина ≥ 16 символов. | — | ОК |

---

### A08:2021 — Software and Data Integrity Failures

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | Webhook Paygine: проверка подписи по документации (Приложение №2, XML + password). | — | ОК |
| 2 | Webhook stub: при заданном `PAYMENT_WEBHOOK_SECRET` — HMAC-SHA256, `timingSafeEqual`. В production без секрета — отказ. | — | ОК |
| 3 | Зависимости из npm без подписи/доверенной цепочки — стандартный риск; снижается обновлениями и lockfile. | Низкий | Рекомендация |

---

### A09:2021 — Security Logging and Monitoring Failures

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | События безопасности логируются: login success/fail/blocked, register, pay init, webhook, change password и др. | — | ОК |
| 2 | В логах контекст санитизируется (пароли, токены, authorization → `[REDACTED]`). | — | ОК |
| 3 | В `prisma/seed.ts` пароль суперадмина больше не выводится в консоль (исправлено ранее). | — | ОК |

---

### A10:2021 — Server-Side Request Forgery (SSRF)

| # | Находка | Риск | Статус |
|---|---------|------|--------|
| 1 | В приложении единственный `fetch` по внешнему URL — в `receipt/route.ts` загрузка шрифта по захардкоженным URL (GitHub, jsdelivr). Пользовательский ввод в URL не подставляется. | — | ОК |
| 2 | Paygine API: URL из `PAYGINE_BASE_URL` (конфиг), не из запроса. | — | ОК |

---

## Уязвимости и замечания вне OWASP Top 10

### 1. Открытый редирект (подмена baseUrl по Host/origin) — исправлено

**Категория:** Open Redirect / Phishing  
**Описание:** См. A01.1. При ненастроенном `NEXT_PUBLIC_APP_URL` редирект после инициализации оплаты мог вести на домен злоумышленника.  
**Исправление:** В production при отсутствии `NEXT_PUBLIC_APP_URL` функция `getBaseUrlFromRequest` возвращает пустую строку; создание платежа с редиректом завершается ошибкой. В production необходимо задавать `NEXT_PUBLIC_APP_URL`.

---

### 2. Path Traversal

**Проверено:** Пути к файлам (чеки, шрифты, лого) строятся из `payout.id` (БД), `process.cwd()`, констант. Пользовательский ввод в пути не используется. **Уязвимостей не выявлено.**

---

### 3. Mass Assignment / Over-Posting

**Проверено:** PATCH/POST обрабатывают только явно описанные в Zod-схемах поля; лишние поля отбрасываются или не маппятся на модель. Критичного риска не выявлено.

---

### 4. Sensitive Data Exposure

| Место | Статус |
|-------|--------|
| Ответы API | Не отдаются пароли, хеши, полные токены. |
| Логи | Санитизация контекста (REDACT_KEYS). |
| Health | Только статус и флаг paygineConfigured. |
| Ошибки 500 | В production без деталей кода. |

---

### 5. Rate Limit и DoS

| Место | Статус |
|-------|--------|
| API | Глобальный лимит 200/15 мин по IP. |
| Auth | 20/15 мин. |
| Webhook | 60/мин. |
| Pay по slug | По IP и по slug. |
| Body size | Ограничение размера тела (512 KB auth, 256 KB webhook). |

In-memory store при нескольких инстансах не даёт общего лимита — для масштабирования рекомендуется Redis.

---

### 6. CSRF

Проверка origin + double-submit cookie (`x-csrf-token`). Исключения: Bearer и webhook. **Реализация корректна.**

---

### 7. Итоговая сводка

| Тип | Количество |
|-----|------------|
| Критические | 0 |
| Средние | 0 (open redirect исправлен) |
| Низкие / рекомендации | 1 (CSP unsafe-inline; актуальность зависимостей). SUPERADMIN и чеки — исправлено. |

**Исправлено в рамках аудита:** открытый редирект при ненастроенном `NEXT_PUBLIC_APP_URL`. В production при отсутствии `NEXT_PUBLIC_APP_URL` функция `getBaseUrlFromRequest` больше не использует `origin` из запроса и возвращает пустую строку; создание платежа с редиректом при этом завершается ошибкой. Для работы оплаты в production необходимо задавать `NEXT_PUBLIC_APP_URL`.
