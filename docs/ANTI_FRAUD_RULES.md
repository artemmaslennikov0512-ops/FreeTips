# Антифрод-правила FreeTips

Документ описывает предлагаемые правила и механизмы защиты от мошенничества для сервиса приёма чаевых. Рекомендуется внедрять поэтапно по приоритету.

---

## 1. Входящие платежи (чаевые)

### 1.1 Rate limiting

| Эндпоинт | Правило | Цель |
|----------|---------|------|
| `POST /api/pay/[slug]` | **60 запросов / 15 мин на IP** | Защита от флуда и автоматизированных атак |
| `POST /api/pay/[slug]` | **30 запросов / 15 мин на slug** | Ограничение накрутки одного получателя |

**Текущее состояние:** rate limit отсутствует.

### 1.2 Лимиты сумм

| Правило | Значение | Цель |
|---------|----------|------|
| Минимальная сумма | **1 руб (100 коп)** | Блокировка микро-тестов кардхолдеров |
| Максимальная сумма (уже есть) | 100 млн ₽ | Сохранить |
| Лимит на один платёж | **50 000 ₽ (5 000 000 коп)** | Снизить риск крупных краденых карт |

### 1.3 Velocity checks (скорость транзакций)

| Правило | Условие | Действие |
|---------|---------|----------|
| Слишком много с одного IP | >10 SUCCESS транзакций за 10 мин | Временная блокировка IP (1 час) + алерт |
| Аномалия по slug | >20 транзакций в час на одну ссылку | Алерт, опционально hold на 24 ч |
| Одинаковые суммы | 3+ платежа одной суммы за 5 мин на slug | Алерт, возможная накрутка |

### 1.4 Идемпотентность и дубли

- **idempotencyKey** уже используется — сохранить.
- Дополнительно: отклонять запросы с повторным `idempotencyKey` от **другого IP** в течение 24 ч (признак replay-атаки).

### 1.5 Геоблокировка и VPN/прокси (опционально)

- Использовать GeoIP для определения страны.
- При необходимости: блокировать известные датацентры, VPN, TOR exit nodes (через сторонние сервисы).

---

## 2. Выводы средств (payouts)

### 2.1 Лимиты на вывод

| Правило | Значение | Цель |
|---------|----------|------|
| Минимальная сумма вывода | **100 ₽ (10 000 коп)** | Снижение нагрузки на обработку |
| Максимум за одну заявку | **100 000 ₽ (10 000 000 коп)** | Ограничение единичного риска |
| Сумма в сутки на пользователя | **200 000 ₽** | Защита от массового вывода |
| Количество заявок в сутки | **5** | Защита от дробления и автоматизации |

### 2.2 Velocity checks

| Правило | Условие | Действие |
|---------|---------|----------|
| Слишком частые выводы | >3 заявок за 1 час | Отклонение + алерт |
| Первый вывод | Сумма >50 000 ₽ при возрасте аккаунта <7 дней | Hold, ручная проверка |
| Накопление и быстрый вывод | Вывод >80% баланса в течение 24 ч после крупных поступлений | Алерт, возможный hold |

### 2.3 Верификация перед выводом (KYC-lite)

- **Обязательно:** заполненные ФИО, дата рождения, заведение.
- **Опционально (фаза 2):** привязка телефона, верификация email.
- **Опционально (фаза 3):** паспорт/selfie для выводов >50 000 ₽ в месяц.

### 2.4 Валидация реквизитов

- Проверка формата: карта (16–19 цифр), СБП (телефон), счёт.
- Запрет явно тестовых реквизитов: `4111111111111111`, `0000000000` и т.п.
- Blacklist известных «мусорных» номеров (из своих инцидентов).

---

## 3. Пользователи и аккаунты

### 3.1 Self-tipping (самочаевые)

**Правило:** Запретить платежи, где плательщик (по cookie/session/fingerprint) совпадает с получателем.

**Реализация:**
- Хранить `fingerprint` или `deviceId` при инициализации платежа.
- При наличии сессии — сопоставлять с `recipientId`.
- При совпадении — отклонять с `error: "Self-tipping is not allowed"`.

### 3.2 Блокировка аккаунтов

- **isBlocked** уже есть — при блокировке отклонять новые платежи на slug и выводы.
- Логировать все попытки действий заблокированным пользователем.

### 3.3 Множественные аккаунты (multi-accounting)

| Сигнал | Действие |
|--------|----------|
| Один IP → несколько аккаунтов | Алерт, флаг для ручной проверки |
| Одинаковые реквизиты на вывод у разных пользователей | Блокировка + расследование |
| Паттерн: один IP много платит разным получателям | Алерт на возможную накрутку |

---

## 4. Инфраструктура и API

### 4.1 Webhook

- **Подпись** уже проверяется — сохранить.
- **Replay protection:** отклонять дубли по `externalId` / `idempotencyKey` в течение 24 ч.
- **Идемпотентность:** повторный webhook с тем же `externalId` → 200 OK без повторного списания.

### 4.2 Blacklist

- **IP:** блокировать по решению поддержки или при автоматическом срабатывании правил.
- **Email/телефон:** при регистрации — проверка на повторное использование после блокировки.
- Хранить в отдельной таблице `FraudBlacklist` или Redis.

### 4.3 Логирование

- Все срабатывания антифрод-правил → `logSecurity` с `rule`, `action`, `userId`, `ip`, `slug`, `amount`.
- Алерты в Telegram/Slack/почту при высоком риске.
- Корреляция по `requestId` для расследования.

---

## 5. Приоритеты внедрения

### Фаза 1 (критично, 1–2 недели)

1. Rate limit на `POST /api/pay/[slug]` (по IP и slug).
2. Минимальная сумма платежа 1 ₽.
3. Лимиты на вывод: мин 100 ₽, макс заявка 100 000 ₽, 5 заявок/сутки.
4. Проверка блокировки `isBlocked` перед приёмом платежа и выводом.

### Фаза 2 (важно, 2–4 недели)

5. Velocity: блокировка при >10 транзакций с IP за 10 мин.
6. Self-tipping: проверка при наличии сессии.
7. Лимит 200 000 ₽/сутки на вывод на пользователя.
8. Blacklist IP (таблица + проверка).

### Фаза 3 (усиление)

9. Алерты и метрики по срабатываниям правил.
10. Валидация реквизитов вывода.
11. Защита от replay по `idempotencyKey` с другого IP.
12. KYC-lite: обязательные поля перед первым выводом.

---

## 6. Метрики для мониторинга

| Метрика | Описание |
|---------|----------|
| `antifraud.rule_triggered` | Счётчик срабатываний по типу правила |
| `antifraud.ip_blocked` | Количество заблокированных IP |
| `antifraud.payment_rejected` | Отклонённые платежи по причинам |
| `antifraud.payout_hold` | Заявки на вывод, отправленные в ручную проверку |
| `antifraud.velocity_ip_10min` | Транзакций с IP за 10 мин (гистограмма) |

---

## 7. Ссылки

- `lib/middleware/rate-limit.ts` — текущий rate limit.
- `app/api/pay/[slug]/route.ts` — точка инициализации платежа.
- `app/api/payouts/route.ts` — создание заявки на вывод.
- `lib/validations.ts` — лимиты сумм.
- `prisma/schema.prisma` — модель `User.isBlocked`, `Transaction`, `PayoutRequest`.
