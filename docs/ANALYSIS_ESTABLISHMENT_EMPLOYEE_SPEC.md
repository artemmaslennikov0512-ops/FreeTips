# Анализ спецификации: Заведения, официанты, распределение чаевых

**Дата:** 2025-02-11  
**Контекст:** Расширение платформы чаевых — заведения (establishments), роли, сотрудники, правила распределения, админ заведения, режим официанта, монетизация и юриспруденция.

---

## 1. Соответствие текущей кодовой базы спецификации

### 1.1 Этап 1: Архитектура данных (БД)

| Требование спецификации | Текущее состояние | Разрыв |
|------------------------|-------------------|--------|
| **Таблица establishments** (id, name, address, phone, logo_url, unique_slug, created_at) | Нет. В `User` есть текстовое поле `establishment` (название), в `RegistrationRequest` — то же. | Нужна новая модель `Establishment` и миграция. |
| **Таблица users: role** (superadmin, establishment_admin, employee) | Есть enum `UserRole`: RECIPIENT, ADMIN, SUPERADMIN. Нет разбиения на establishment_admin и employee. | Расширить enum: добавить ESTABLISHMENT_ADMIN, EMPLOYEE (или переименовать RECIPIENT → EMPLOYEE и ввести ESTABLISHMENT_ADMIN). |
| **Таблица users: establishment_id** | Есть `User.establishment` (String, название заведения), нет FK на заведение. | Заменить на `establishmentId String?` с отношением к `Establishment`. |
| **Таблица employees** (id, establishment_id, name, position, is_active, qr_code_identifier) | Нет. Сейчас получатель чаевых = User + TipLink(slug). Один пользователь может иметь несколько ссылок, но нет сущности "сотрудник заведения" с QR-идентификатором. | Новая модель `Employee`; связь Establishment → Employee; QR = slug или отдельное поле. |
| **Таблица payout_rules** (id, establishment_id, name, type, value) | Нет. Распределение чаевых не реализовано — каждый вывод привязан к одному User, баланс = поступления − выводы. | Новая модель `PayoutRule`; логика распределения — новый доменный слой. |

**Итог по Этапу 1:** Текущая схема — "плоская": пользователь-получатель, ссылка, транзакции, выводы. Спецификация вводит иерархию Заведение → Сотрудники и правила распределения. Требуются новые таблицы и изменение `User`/ролей.

---

### 1.2 Этап 2: Администратор заведения

| Функционал | Сейчас | Что нужно |
|-----------|--------|-----------|
| **Управление командой: ручное добавление** (имя → QR, PDF) | Нет. Регистрация только через заявку + токен, один User = один аккаунт. | Создание записей Employee без User (или с опциональным User); генерация уникального slug/QR; генерация PDF (библиотека, например pdf-lib или react-pdf). |
| **Управление командой: приглашение (SMS/Email)** | Нет SMS/Email инвайтов. Есть только RegistrationRequest → токен → регистрация. | Поток инвайта: создание Employee + отправка ссылки/кода; привязка существующего User к Employee (или регистрация по инвайту). Канал SMS/Email — инфраструктура (сервис отправки). |
| **Архив/увольнение** (деактивация) | Есть `User.isBlocked`. Нет сущности "смена" или "активен в заведении". | Поле `Employee.isActive`; при is_active=false чаевые на этот QR не принимаются или не учитываются в распределении (уточнить в бизнес-правилах). |
| **Распределение: Вариант А (равномерно)** | Нет. Каждый получает по своей ссылке. | Агрегация транзакций по заведению/смене; деление суммы на N активных; зачисление на балансы или отдельная сущность "начисление". |
| **Распределение: Вариант Б (коэффициенты KPI)** | Нет. | Поле веса у Employee (или в PayoutRule по роли); формула: сумма / sum(коэффициентов) * коэффициент_i. |
| **Распределение: Вариант В (гибрид)** | Частично: личный QR уже даёт 100% конкретному получателю. Нет "общих" чаевых и ручного ввода. | Модель "общие чаевые" (источник: наличные/терминал), привязка к смене/дню; распределение по правилам. |
| **Аналитика: графики, отчёты** | Нет. В админке суперадмина — список заявок, пользователи, выводы, базовая статистика. | Новые отчёты: по заведению, по сотрудникам, по дням; экспорт для бухгалтерии (CSV/PDF). |

**Итог по Этапу 2:** Требуется отдельный раздел UI/роуты для "админ заведения" (не путать с суперадмином). Разграничение прав: суперадмин — вся платформа; establishment_admin — только своё заведение. Логика распределения — сердце изменений (расчёт, начисление, аудит).

---

### 1.3 Этап 3: Официант (Employee Mode)

| Функционал | Сейчас | Что нужно |
|------------|--------|-----------|
| **Личный кабинет** (рейтинг, история начислений) | Есть кабинет пользователя: баланс, выводы, транзакции, настройки. Нет "рейтинга" и отдельного вида "начислений от заведения". | Разделение UX: если role=EMPLOYEE и привязан к заведению — показывать начисления по правилам, рейтинг (если введён). |
| **Вывод на карту** | Есть: пользователь создаёт заявку на вывод, суперадмин обрабатывает. | Без изменений для официанта; опционально — пониженная комиссия для заведений (конфиг/флаг). |
| **Мгновенные выплаты** (за доп. комиссию) | Нет. Только ручная обработка суперадмином. | Интеграция с провайдером мгновенных переводов (СБП, карта); комиссия и лимиты — продукт и юриспруденция. |

**Итог по Этапу 3:** В основном расширение текущего кабинета и правил комиссий; мгновенные выплаты — отдельный контур интеграции и рисков.

---

### 1.4 Этап 4: Фишки и монетизация

| Идея | Сложность | Зависимости |
|------|-----------|-------------|
| **White Label** (логотип, цвета заведения) | Средняя. Конфиг на уровне Establishment (logo_url уже в спецификации), темы/цвета в конфиге или CSS variables. | Establishment; отдача конфига на фронт при открытии страницы оплаты по slug заведения. |
| **Интеграция R-Keeper / iiko** | Высокая. API САУ, привязка стола к официанту, маппинг чек → сотрудник. | Дорого в разработке и поддержке; отдельный bounded context, контракты. |
| **Благотворительность** (1% в фонд) | Средняя. Правило распределения "процент в фонд"; отдельный получатель или внешний платёж. | PayoutRule или отдельная сущность; согласование с заведением. |
| **Геймификация** (звания, отзывы) | Средняя. Новая сущность "отзыв"/"рейтинг" при оплате; звания по правилам. | Транзакция + опциональный отзыв; расчёт рейтинга. |

---

### 1.5 Этап 5: Безопасность и юриспруденция

| Тема | Текущее состояние | Рекомендация по спецификации |
|------|-------------------|------------------------------|
| **Юрлицо и поток денег** | Платёжный шлюз (stub); вывод обрабатывается вручную. Спецификация: клиент платит ООО "Твой Сайт", комиссия удерживается, остаток — официанту/самозанятому. | Закрепить в ADR: кто контрагент, как проходит безнал (агентская схема/договор с заведением). Реализация — на уровне договоров и интеграции с платёжным провайдером. |
| **Самозанятость, проверка ФНС** | Нет. | Массовая проверка через API ФНС перед выплатой — отдельный сервис/адаптер; при отсутствии статуса — блок или удержание НДФЛ (требуется юрист). |
| **Антифрод: неизменяемость истории** | Нет явного аудита изменений распределений. Есть логирование в коде (logError, logSecurity). | Все изменения правил распределения и ручные корректировки — в audit log (таблица или append-only лог); запрет изменения задним числом на уровне правил и кода. |

---

## 2. Предлагаемая схема данных (Prisma) для Этапа 1

Ниже — целевая модель без миграций (только концепт). Реальные миграции делать пошагово.

```prisma
// Новые/изменённые сущности (концепт)

model Establishment {
  id         String   @id @default(cuid())
  name       String   @db.VarChar(255)
  address    String?  @db.Text
  phone      String?  @db.VarChar(50)
  logoUrl    String?  @db.VarChar(512)
  uniqueSlug String   @unique @db.VarChar(50)  // momo-pizza
  createdAt  DateTime @default(now())

  employees    Employee[]
  payoutRules  PayoutRule[]
  users        User[]         // establishment_admin привязаны сюда
  tipLinks     TipLink[]      // опционально: ссылки уровня заведения
  @@map("establishments")
}

enum UserRole {
  SUPERADMIN
  ESTABLISHMENT_ADMIN  // админ конкретного заведения
  EMPLOYEE             // официант (может быть привязан к Employee)
  RECIPIENT            // получатель без заведения (как сейчас)
  ADMIN                // deprecated или оставить для обратной совместимости
}

model User {
  // ... существующие поля ...
  role              UserRole  @default(RECIPIENT)
  establishmentId   String?   // для ESTABLISHMENT_ADMIN и привязки к заведению
  establishment     Establishment? @relation(fields: [establishmentId], references: [id], onDelete: SetNull)
  employeeProfile   Employee? // 1:1 если роль EMPLOYEE и привязан к сотруднику
  // establishment (текст) можно оставить для обратной совместимости или мигрировать в establishmentId
}

model Employee {
  id                  String   @id @default(cuid())
  establishmentId     String
  name                String   @db.VarChar(255)
  position            String?  @db.VarChar(100)  // официант, бармен, стажёр
  coefficient         Decimal  @default(1) @db.Decimal(5,2)  // для Варианта Б
  isActive            Boolean  @default(true)
  qrCodeIdentifier    String   @unique @db.VarChar(50)  // slug для QR /pay/[qrCodeIdentifier]
  userId              String?  @unique  // привязка к аккаунту (при инвайте)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  user           User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  // транзакции можно связать по linkId -> TipLink -> slug = qrCodeIdentifier или по recipientId = userId
  @@index([establishmentId])
  @@index([qrCodeIdentifier])
  @@map("employees")
}

model PayoutRule {
  id              String   @id @default(cuid())
  establishmentId String
  name            String   @db.VarChar(100)   // "Стандарт"
  type            String   @db.VarChar(20)    // "percentage" | "fixed"
  value           Decimal  @db.Decimal(12,4)  // процент или фикс в копейках
  createdAt       DateTime @default(now())

  establishment Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  @@index([establishmentId])
  @@map("payout_rules")
}
```

**Связь чаевых и сотрудников:**  
- Личный QR официанта: slug страницы оплаты = `Employee.qrCodeIdentifier`. Нужно решить: создаём ли TipLink на каждого Employee автоматически (recipientId = userId после привязки) или храним транзакции по linkId, где link привязан к Employee. Текущая модель: TipLink → User. Варианты: (1) Employee с userId → тот же User, у User есть TipLink с slug = qrCodeIdentifier; (2) ввести TipLink.employeeId и разрешить ссылку без User до привязки (тогда recipientId заполнять при зачислении по правилам заведения). Выбор влияет на то, как считать баланс и распределение.

---

## 3. Риски и ограничения

| Риск | Описание | Митигация |
|------|----------|-----------|
| **Миграция ролей** | Добавление ESTABLISHMENT_ADMIN и EMPLOYEE ломает текущие проверки `role === "ADMIN"`. | Поэтапная миграция: ввести новые роли, считать ADMIN = ESTABLISHMENT_ADMIN или маппить в коде; обновить все проверки и middleware. |
| **Два типа получателей** | Сейчас получатель = User. По спецификации — сотрудник (Employee) с опциональным User. | Чётко разделить: "чаевые на QR сотрудника" зачисляются на счёт User (если привязан) или во "внутренний баланс заведения" с последующим распределением. |
| **Распределение и баланс** | Текущий баланс = транзакции − выводы по userId. При распределении появляется "пул за смену" и начисление долей. | Ввести сущность "начисление" (allocation) или учитывать распределённые суммы в балансе пользователя через отдельные транзакции/записи. Аудит: каждая сумма должна быть прослеживаема до правил и смены. |
| **Юридическая схема** | Кто кому платит: гость → платформа → официант/самозанятый. | Фиксировать в ADR и с юристом; реализация выплат и комиссий — в соответствии с договорами. |
| **Аудит и антифрод** | Запрет менять историю распределений задним числом. | Append-only лог изменений правил и ручных корректировок; в коде — запрет update/delete записей распределений за прошлые периоды. |

---

## 4. Рекомендуемый порядок внедрения

1. **Фаза 1 — Данные и роли**  
   - Модель `Establishment`, миграция.  
   - Расширение `UserRole` (ESTABLISHMENT_ADMIN, EMPLOYEE), поле `User.establishmentId`.  
   - Миграция существующих пользователей (establishment строка → связь с созданным/найденным заведением или null).  
   - Модели `Employee` и `PayoutRule` с миграциями.

2. **Фаза 2 — Админ заведения**  
   - Роуты и UI: только для пользователей с ролью ESTABLISHMENT_ADMIN и своим establishmentId.  
   - CRUD сотрудников, генерация QR (slug), выдача PDF с QR.  
   - Базовое распределение: Вариант А (равномерно) или только учёт по сотрудникам без изменения текущего потока чаевых.

3. **Фаза 3 — Связка чаевых и сотрудников**  
   - Привязка slug страницы оплаты к Employee (личный QR).  
   - Пул "общих" чаевых (ручной ввод админом) и распределение по правилам (Варианты Б/В).  
   - Отчёты и аналитика по заведению.

4. **Фаза 4 — Официант и выплаты**  
   - Личный кабинет официанта (начисления, рейтинг).  
   - Пониженная комиссия для заведений (конфиг).  
   - Мгновенные выплаты — отдельный проект (провайдер, комиссии, лимиты).

5. **Фаза 5 — Дополнительно**  
   - White Label (конфиг заведения).  
   - Благотворительность, геймификация.  
   - Интеграция САУ (iiko/R-Keeper) — отдельный дорогой контур.  
   - Проверка ФНС (самозанятость), аудит-лог распределений.

---

## 5. AQB Summary

- **[AQB:Sec]** Роли и establishmentId дают основу для разграничения доступа; все действия админа заведения проверять по establishmentId. Аудит изменений распределений — обязательно.  
- **[AQB:Test]** После введения новых моделей — юнит-тесты расчёта распределения (равномерный и по коэффициентам); интеграционные тесты прав (establishment_admin видит только своё заведение).  
- **[AQB:Perf]** Индексы по establishmentId, qrCodeIdentifier, датам; агрегации по заведению/смене не должны сканировать все транзакции без фильтров.  
- **[AQB:Maint]** Спецификация затрагивает весь поток чаевых; целесообразно выделить bounded contexts (Establishment, Employee, PayoutDistribution) и по возможности следовать рекомендациям ARCHITECTURE_ASSESSMENT (порты, use cases).  
- **[AQB:Doc]** Обновить API.md и ADR при принятии схемы ролей и моделей; документировать формулы распределения и правила аудита.  
- **[AQB:Biz]** Юрлицо, самозанятость и антифрод — критичны для запуска; согласовать с юристом и продуктом до реализации выплат официантам.

---

Документ можно использовать как основу для ADR по расширению модели данных и ролей (например, ADR 0003) и для постановки задач по фазам.
