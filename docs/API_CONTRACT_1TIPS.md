# Контракт API для подключения приложения FreeTips к сайту 1tips

Чтобы приложение могло подключаться к личному кабинету и получать уведомления из истории операций, бэкенд 1tips должен реализовать следующий контракт.

---

## Где брать API-ключ (для пользователя)

**API-ключ выдаётся на самом сайте 1tips в личном кабинете.**

Пользователь должен:

1. Войти на сайт 1tips в свой личный кабинет.
2. Открыть раздел вроде **«Приложение»**, **«Подключение приложения»**, **«API-ключ»** или **«Мобильное приложение»** (название задаётся на сайте).
3. Увидеть свой API-ключ (или нажать «Создать ключ» / «Сгенерировать», если ключа ещё нет).
4. Скопировать ключ и в приложении FreeTips ввести: адрес сайта (например, `https://ваш-сайт.ru`) и этот ключ.

Если такого раздела на сайте пока нет — его нужно добавить (см. ниже для разработчиков сайта).

---

## Для разработчиков сайта 1tips: как выдать API-ключ

В личном кабинете нужна страница или блок, где пользователь видит свой **API-ключ** для приложения.

### Что сделать на бэкенде

1. **Хранение ключа:** у каждого пользователя (user_id) в БД храните один API-ключ (строка, например UUID или случайная строка 32+ символов). Можно генерировать при первом заходе в раздел или по кнопке «Сгенерировать ключ».
2. **Выдача на фронте:** в ЛК покажите этот ключ только авторизованному пользователю (например, страница «Подключение приложения» с полем «Ваш API-ключ» и кнопкой «Копировать»). По желанию — кнопка «Создать новый ключ» (старый при этом инвалидируется, все старые сессии приложения перестанут работать до повторного ввода ключа).
3. **Авторизация API:** при запросах с заголовком `X-API-Key` определяйте пользователя по этому ключу и отдавайте только его данные (история операций, WebSocket и т.д.).

### Пример текста для страницы в ЛК

- Заголовок: «Подключение мобильного приложения» или «API-ключ для приложения».
- Текст: «Скопируйте ключ ниже и введите его в приложении FreeTips вместе с адресом этого сайта. По этому ключу приложение получит доступ к вашей истории операций и уведомлениям.»

---

## Авторизация (технически)

- Все запросы к API должны приниматься с заголовком:
  - **`X-API-Key`**: API-ключ пользователя (тот, что выдан в личном кабинете на сайте).
- По этому ключу бэкенд определяет пользователя и возвращает только его данные.

## Эндпоинты

### История операций

- **Метод:** `GET`
- **Путь:** `/api/operations` (альтернатива: `/api/history`)
- **Заголовки:** `X-API-Key: <ключ>`
- **Query (опционально):** `page`, `limit` (приложение передаёт `limit=100`).

**Ожидаемый формат ответа:** JSON-массив объектов операций. Если у вас обёртка (например, `{ "data": [...] }`), в приложении нужно будет добавить DTO и поправить парсинг в `OneTipsApi` и `Operation`.

**Пример тела ответа (массив):**

```json
[
  {
    "id": "op-1",
    "type": "tip",
    "title": "Получен чаевые",
    "description": "От клиента №123",
    "amount": 150.50,
    "currency": "RUB",
    "created_at": "2025-02-10T12:00:00Z"
  }
]
```

**Поля объекта операции (в приложении используются как есть, часть опциональна):**

| Поле          | Тип    | Обязательное | Описание        |
|---------------|--------|--------------|-----------------|
| `id`          | string | да           | Уникальный ID   |
| `title`       | string | да           | Заголовок       |
| `type`        | string | нет          | Тип операции    |
| `description` | string | нет          | Описание        |
| `amount`      | number | нет          | Сумма           |
| `currency`    | string | нет          | Валюта          |
| `created_at`  | string | нет          | ISO 8601 дата   |

Поддерживается также поле `createdAt` (camelCase) вместо `created_at`.

## Если путь или формат отличаются

- Путь: в `OneTipsApi.kt` замените `"api/operations"` на ваш (например, `"api/history"`).
- Обёртка ответа: создайте data-класс (например, `OperationsResponse(val data: List<Operation>)`) и измените метод API на возврат `Response<OperationsResponse>`, в репозитории берите `response.body()?.data`.
- Имя заголовка API-ключа: в `ApiKeyInterceptor` по умолчанию используется `X-API-Key`; при необходимости замените на `Authorization: Bearer <key>` и т.п.

## Мгновенное обновление (WebSocket)

Подключение к **WebSocket** (`/ws?api_key=<ключ>`) даёт мгновенное обновление при зачислении баланса. Резервное опросление раз в 2 минуты (WorkManager) сохранено на случай потери соединения.
